# Nombre del Workflow
name: Deploy to GitHub Pages

# Se ejecuta cada vez que haces un push a la rama 'main'
on: 
  push:
    branches:
      - main # Cambia a 'master' si esa es tu rama principal

# Permisos necesarios para que el workflow pueda escribir en la rama gh-pages
permissions:
  contents: write

# Define el trabajo a realizar
jobs:
  build-and-deploy:
    # El tipo de mÃ¡quina virtual en la que se ejecutarÃ¡ el trabajo (runner)
    runs-on: ubuntu-latest

    steps:
      # 1. Clona tu repositorio en la mÃ¡quina virtual
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v4

      # 2. Crea el archivo firebase-config.js usando los secrets
      - name: Create Firebase Config File ðŸ¤«
        run: |
          echo "export const firebaseConfig = {" > firebase-config.js
          echo "  apiKey: '${{ secrets.FIREBASE_API_KEY }}'," >> firebase-config.js
          echo "  authDomain: '${{ secrets.FIREBASE_AUTH_DOMAIN }}'," >> firebase-config.js
          echo "  projectId: '${{ secrets.FIREBASE_PROJECT_ID }}'," >> firebase-config.js
          echo "  storageBucket: '${{ secrets.FIREBASE_STORAGE_BUCKET }}'," >> firebase-config.js
          echo "  messagingSenderId: '${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}'," >> firebase-config.js
          echo "  appId: '${{ secrets.FIREBASE_APP_ID }}'" >> firebase-config.js
          echo "};" >> firebase-config.js

      # 2b. Crea el archivo meta-pixel-config.js usando el secret
      - name: Create Meta Pixel Config File ðŸ“Š
        run: |
          cat > meta-pixel-config.js << 'EOF'
          const metaPixelConfig = {
            pixelId: '${{ secrets.META_PIXEL_ID }}',
            enabled: true,
            debug: false,
            advanced: {
              autoConfig: true,
              customEvents: {
                viewMenu: 'ViewMenu',
                selectCategory: 'SelectCategory',
                viewProduct: 'ViewContent',
                addToCart: 'AddToCart',
                removeFromCart: 'RemoveFromCart',
                initiateCheckout: 'InitiateCheckout',
                contactWhatsApp: 'Contact'
              }
            }
          };

          function initMetaPixel() {
            if (!metaPixelConfig.enabled) {
              if (metaPixelConfig.debug) {
                console.log('Meta Pixel estÃ¡ deshabilitado');
              }
              return;
            }

            if (metaPixelConfig.pixelId === 'YOUR_PIXEL_ID_HERE' || !metaPixelConfig.pixelId) {
              console.warn('âš ï¸ Meta Pixel: Configura tu Pixel ID en GitHub Secrets');
              return;
            }

            !function(f,b,e,v,n,t,s) {
              if(f.fbq) return;
              n=f.fbq=function(){
                n.callMethod ? n.callMethod.apply(n,arguments) : n.queue.push(arguments)
              };
              if(!f._fbq) f._fbq=n;
              n.push=n;
              n.loaded=!0;
              n.version='2.0';
              n.queue=[];
              t=b.createElement(e);
              t.async=!0;
              t.src=v;
              s=b.getElementsByTagName(e)[0];
              s.parentNode.insertBefore(t,s)
            }(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

            fbq('init', metaPixelConfig.pixelId);
            fbq('track', 'PageView');

            if (metaPixelConfig.debug) {
              console.log('âœ… Meta Pixel inicializado:', metaPixelConfig.pixelId);
            }
          }

          function trackMetaEvent(eventName, params = {}) {
            if (!metaPixelConfig.enabled || typeof fbq === 'undefined') {
              return;
            }

            try {
              fbq('track', eventName, params);

              if (metaPixelConfig.debug) {
                console.log(`ðŸ“Š Meta Pixel Event: ${eventName}`, params);
              }
            } catch (error) {
              console.error('Error al rastrear evento de Meta Pixel:', error);
            }
          }

          function trackCustomMetaEvent(eventName, params = {}) {
            if (!metaPixelConfig.enabled || typeof fbq === 'undefined') {
              return;
            }

            try {
              fbq('trackCustom', eventName, params);

              if (metaPixelConfig.debug) {
                console.log(`ðŸ“Š Meta Pixel Custom Event: ${eventName}`, params);
              }
            } catch (error) {
              console.error('Error al rastrear evento personalizado:', error);
            }
          }

          function trackProductView(product) {
            if (!product) return;

            trackMetaEvent('ViewContent', {
              content_name: product.name,
              content_category: product.category || product.type,
              content_ids: [product.id],
              content_type: 'product',
              value: product.price,
              currency: 'MXN'
            });
          }

          function trackAddToCart(product, quantity = 1) {
            if (!product) return;

            trackMetaEvent('AddToCart', {
              content_name: product.name,
              content_category: product.category || product.type,
              content_ids: [product.id],
              content_type: 'product',
              value: product.price * quantity,
              currency: 'MXN',
              quantity: quantity
            });
          }

          function trackInitiateCheckout(cartItems, totalValue) {
            if (!cartItems || cartItems.length === 0) return;

            const contentIds = cartItems.map(item => item.id || item.name);
            const contents = cartItems.map(item => ({
              id: item.id || item.name,
              quantity: item.quantity || 1,
              item_price: item.price
            }));

            trackMetaEvent('InitiateCheckout', {
              content_ids: contentIds,
              contents: contents,
              content_type: 'product',
              value: totalValue,
              currency: 'MXN',
              num_items: cartItems.length
            });
          }

          function trackWhatsAppContact(source = 'unknown') {
            trackMetaEvent('Contact', {
              contact_type: 'whatsapp',
              source: source
            });
          }

          function trackCategorySelection(categoryName) {
            trackCustomMetaEvent('SelectCategory', {
              category_name: categoryName
            });
          }

          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMetaPixel);
          } else {
            initMetaPixel();
          }

          window.metaPixel = {
            track: trackMetaEvent,
            trackCustom: trackCustomMetaEvent,
            trackProductView,
            trackAddToCart,
            trackInitiateCheckout,
            trackWhatsAppContact,
            trackCategorySelection
          };
          EOF

      # 3. Despliega los archivos a la rama gh-pages
      - name: Deploy ðŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages # La rama donde se desplegarÃ¡
          folder: . # La carpeta a desplegar (la raÃ­z del proyecto)