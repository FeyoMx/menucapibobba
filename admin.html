<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- A√±adir un icono para la pesta√±a del navegador -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/llR0NN0.png">
    <title>Admin Panel - Capibobba</title>
    <link rel="stylesheet" href="admin-styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Balsamiq+Sans:wght@700&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Mensaje para usuarios no autenticados -->
    <div id="auth-message" class="login-container" style="display: none;">
        <div class="login-box">
            <img src="https://i.imgur.com/llR0NN0.png" alt="Capibobba Admin" width="80" height="80">
            <h2>Acceso de Administrador</h2>
            <p>Para gestionar el men√∫, por favor, inicia sesi√≥n con tu cuenta de Google autorizada.</p>
            <button id="googleSignInBtn" class="admin-btn">
                <svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="18px" height="18px" viewBox="0 0 48 48" class="google-icon"><g><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></g></svg>
                <span>Iniciar Sesi√≥n con Google</span>
            </button>
            <p id="loginError" class="error-message" style="display: none;"></p>
        </div>
    </div>

    <!-- Header del Admin Panel -->
    <header class="admin-header" style="display: flex;">
        <div class="admin-logo">
            <img src="https://i.imgur.com/llR0NN0.png" alt="Capibobba Admin" width="60" height="60">
            <h1>Panel de Administraci√≥n Capibobba</h1>
        </div>
        <div class="admin-actions">
            <!-- Botones de exportar e importar se mantendr√°n por ahora, pero la l√≥gica cambiar√° -->
            <button id="exportDataBtn" class="admin-btn export">üì§ Exportar Datos (Local)</button>
            <button id="importDataBtn" class="admin-btn import">üì• Importar Datos (Local)</button>
            <input type="file" id="importFileInput" accept=".json" style="display: none;">
            <a href="index.html" class="admin-btn view-menu">üëÄ Ver Men√∫</a>
            <button id="logoutBtn" class="admin-btn logout">üö™ Cerrar Sesi√≥n</button>
        </div>
    </header>

    <!-- Contenedor principal del panel -->
    <div class="admin-container" style="display: block;">
        <!-- Navegaci√≥n de categor√≠as -->
        <nav class="category-nav">
            <button class="category-btn active" data-category="waterFrappes">Frapp√©s Agua</button>
            <button class="category-btn" data-category="milkFrappes">Frapp√©s Leche</button>
            <button class="category-btn" data-category="hotDrinks">Bebidas Calientes</button>
            <button class="category-btn" data-category="toppings">Toppings</button>
            <button class="category-btn" data-category="promotions">Promociones</button>
        </nav>

        <!-- Secci√≥n de productos -->
        <section class="products-section">
            <header class="section-header">
                <h2 id="currentCategoryTitle">Frapp√©s Base Agua</h2>
                <button id="addProductBtn" class="admin-btn add">‚ûï A√±adir Nuevo Producto</button>
            </header>
            <div id="productsGrid" class="products-grid">
                <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
                <p class="loading-message">Cargando productos...</p>
            </div>
        </section>
    </div>

    <!-- Modal de edici√≥n/adici√≥n de producto -->
    <div id="productModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <button class="close-modal-button" aria-label="Cerrar modal">‚úñ</button>
            <h3 id="modalTitle">A√±adir Nuevo Producto</h3>
            <form id="productForm">
                <div class="form-group">
                    <label for="productName">Nombre:</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label for="productDisplayName">Nombre para Mostrar (opcional):</label>
                    <input type="text" id="productDisplayName">
                </div>
                <div class="form-group">
                    <label for="productDescription">Descripci√≥n:</label>
                    <textarea id="productDescription" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="productPrice">Precio:</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="productImage">URL de la Imagen:</label>
                    <input type="url" id="productImage" placeholder="https://ejemplo.com/imagen.jpg">
                    <div class="image-preview" id="imagePreview"></div>
                </div>

                <div class="form-group form-group-toggle">
                    <label for="productIsActive">Producto Activo:</label>
                    <input type="checkbox" id="productIsActive" class="toggle-switch">
                    <span class="toggle-label">El producto se mostrar√° en el men√∫.</span>
                </div>

                <div class="form-group" id="categorySpecificFields">
                    <!-- Campos espec√≠ficos por categor√≠a se a√±adir√°n aqu√≠ -->
                </div>

                <div class="form-actions">
                    <button type="button" id="cancelBtn" class="admin-btn cancel">Cancelar</button>
                    <button type="submit" class="admin-btn save">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n para eliminar -->
    <div id="confirmModal" class="modal-overlay" role="alertdialog" aria-modal="true" aria-labelledby="confirmModalTitle" aria-describedby="confirmMessage">
        <div class="modal-content confirm-modal">
            <h3 id="confirmModalTitle">¬øConfirmar eliminaci√≥n?</h3>
            <p id="confirmMessage">¬øEst√°s seguro de que quieres eliminar este producto?</p>
            <div class="form-actions">
                <button id="confirmCancel" class="admin-btn cancel">Cancelar</button>
                <button id="confirmDelete" class="admin-btn delete">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta Personalizado (Reemplaza alert()) -->
    <div id="customAlertModal" class="modal-overlay" role="alertdialog" aria-modal="true" aria-labelledby="customAlertTitle" aria-describedby="customAlertMessage">
        <div class="modal-content custom-alert-modal">
            <h3 id="customAlertTitle"></h3>
            <p id="customAlertMessage"></p>
            <button id="customAlertCloseBtn" class="admin-btn">Aceptar</button>
        </div>
    </div>

    <!-- Toast para notificaciones -->
    <div id="toast" class="toast"></div>

    <!-- Plantilla para la tarjeta de producto -->
    <template id="productCardTemplate">
        <div class="product-card">
            <img data-src="" alt="" class="product-image lazy-load" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ADD8E6/000000?text=No+Image';">
            <h4 class="product-name"></h4>
            <p class="product-description"></p>
            <p class="product-price"></p>
            <div class="product-status">
                <label class="switch">
                    <input type="checkbox" class="status-toggle">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="product-actions">
                <button class="admin-btn edit-btn">‚úèÔ∏è Editar</button>
                <button class="admin-btn delete-btn">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </template>

    <!-- Carga de admin-script.js como un M√ìDULO -->
    <script src="admin-script.js" type="module"></script>

    <!-- Carga de Firebase SDK y l√≥gica de inicializaci√≥n -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { firebaseConfig } from './firebase-config.js'; // Importar configuraci√≥n centralizada

        // Funci√≥n para mostrar el modal de alerta personalizado
        window.showCustomAlert = function(title, message) {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            if (window.openModal) window.openModal(document.getElementById('customAlertModal'));
        };

        // Event listener para cerrar el modal de alerta
        document.getElementById('customAlertCloseBtn').addEventListener('click', () => {
            if (window.closeModal) window.closeModal(document.getElementById('customAlertModal'));
        });

        // Inicializar Firebase y autenticar
        async function initializeFirebase() {
            // Validar que firebaseConfig no est√© vac√≠o
            if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                console.error("Firebase config is incomplete. Please update firebaseConfig with your actual Firebase project details.");
                window.showCustomAlert('Error de Configuraci√≥n', 'La configuraci√≥n de Firebase est√° incompleta. Por favor, edita index.html y admin.html con los detalles de tu proyecto Firebase.');
                return; // Detener la inicializaci√≥n
            }

            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                const appId = firebaseConfig.projectId; // Usamos projectId como appId para Firestore
                
                // --- Referencias a elementos del DOM (actualizadas) ---
                const authMessage = document.getElementById('auth-message');
                const adminHeader = document.querySelector('.admin-header');
                const adminContainer = document.querySelector('.admin-container');
                const logoutBtn = document.getElementById('logoutBtn');
                const googleSignInBtn = document.getElementById('googleSignInBtn');
                const loginError = document.getElementById('loginError');

                // --- L√≥gica de Autenticaci√≥n ---

                // 0. Manejar el click en el bot√≥n de Iniciar Sesi√≥n con Google
                googleSignInBtn.addEventListener('click', async () => {
                    const provider = new GoogleAuthProvider();
                    loginError.style.display = 'none'; // Ocultar errores previos

                    try {
                        await signInWithPopup(auth, provider);
                        // onAuthStateChanged se encargar√° de mostrar el panel de admin
                    } catch (error) {
                        console.error("Error durante el inicio de sesi√≥n con Google:", error);
                        let errorMessage = "No se pudo iniciar sesi√≥n. Int√©ntalo de nuevo.";
                        if (error.code === 'auth/popup-closed-by-user') {
                            errorMessage = "Ventana de inicio de sesi√≥n cerrada antes de completar.";
                        }
                        loginError.textContent = errorMessage;
                        loginError.style.display = 'block';
                    }
                });

                // 1. Escuchar cambios en el estado de autenticaci√≥n
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Usuario est√° autenticado
                        const userId = user.uid;

                        console.log("Usuario autenticado:", userId);

                        // Ocultar login y mostrar panel de admin
                        authMessage.style.display = 'none';
                        adminHeader.style.display = 'flex';
                        adminContainer.style.display = 'block'; // Asegurarse que sea block

                        // Iniciar la l√≥gica del panel de administraci√≥n
                        if (typeof window.initAdminPanel === 'function') {
                            window.initAdminPanel(db, userId, appId);
                        } else {
                            console.error("Error: window.initAdminPanel no es una funci√≥n. Aseg√∫rate de que admin-script.js se cargue correctamente como un m√≥dulo.");
                            window.showCustomAlert('Error Interno', 'No se pudo iniciar el panel de administraci√≥n. Por favor, contacta a soporte.');
                        }
                    } else {
                        // Usuario no est√° autenticado
                        console.log("Usuario no autenticado.");
                        
                        // Mostrar mensaje de autenticaci√≥n y ocultar panel de admin
                        authMessage.style.display = 'flex';
                        adminHeader.style.display = 'none';
                        adminContainer.style.display = 'none';
                    }
                });

                // 3. Manejar el cierre de sesi√≥n
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        // onAuthStateChanged se encargar√° de mostrar la pantalla de login
                    } catch (error) {
                        console.error("Error al cerrar sesi√≥n:", error);
                        window.showCustomAlert('Error', 'No se pudo cerrar la sesi√≥n.');
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                window.showCustomAlert('Error de Inicializaci√≥n', 'No se pudo conectar con el servidor de administraci√≥n. Por favor, int√©ntalo de nuevo m√°s tarde. Verifica tu configuraci√≥n de Firebase.');
            }
        };

        // Asegurarse de que el DOM est√© completamente cargado antes de inicializar Firebase
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
