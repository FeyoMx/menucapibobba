<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO Meta Tags -->
    <meta name="description" content="Panel de administraci√≥n de Capibobba - Gestiona el men√∫ de bebidas, frapp√©s y especialidades. Acceso restringido para administradores.">
    <meta name="robots" content="noindex, nofollow">
    <!-- A√±adir un icono para la pesta√±a del navegador -->
    <link rel="icon" type="image/png" href="https://i.imgur.com/llR0NN0.png">
    <link rel="canonical" href="https://feyomx.github.io/menucapibobba/admin.html">
    <title>Admin Panel - Capibobba</title>
    <link rel="stylesheet" href="admin-styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Balsamiq+Sans:wght@700&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Mensaje para usuarios no autenticados -->
    <div id="auth-message" class="login-container">
        <div class="login-box">
            <img src="https://i.imgur.com/llR0NN0.png" alt="Capibobba Admin" width="80" height="80">
            <h2>Acceso de Administrador</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Correo Electr√≥nico:</label>
                    <input type="email" id="email" required>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a:</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="admin-btn login-btn">Iniciar Sesi√≥n</button>
            </form>
            <p id="loginError" class="error-message" style="display: none;"></p>
        </div>
    </div>

    <!-- Header del Admin Panel -->
    <header class="admin-header" style="display: none;">
        <div class="admin-logo">
            <img src="https://i.imgur.com/llR0NN0.png" alt="Capibobba Admin" width="60" height="60">
            <h1>Panel de Administraci√≥n Capibobba</h1>
        </div>
        <div class="admin-actions">
            <!-- Botones de exportar e importar se mantendr√°n por ahora, pero la l√≥gica cambiar√° -->
            <button id="exportDataBtn" class="admin-btn export">üì§ Exportar Datos (Local)</button>
            <button id="importDataBtn" class="admin-btn import">üì• Importar Datos (Local)</button>
            <input type="file" id="importFileInput" accept=".json" style="display: none;">
            <a href="index.html" class="admin-btn view-menu">üëÄ Ver Men√∫</a>
            <button id="logoutBtn" class="admin-btn logout">üö™ Cerrar Sesi√≥n</button>
        </div>
    </header>

    <!-- Contenedor principal del panel -->
    <div class="admin-container" style="display: none;">
        <!-- Navegaci√≥n de categor√≠as -->
        <nav class="category-nav">
            <button class="category-btn active" data-category="waterFrappes">Frapp√©s Agua</button>
            <button class="category-btn" data-category="milkFrappes">Frapp√©s Leche</button>
            <button class="category-btn" data-category="hotDrinks">Bebidas Calientes</button>
            <button class="category-btn" data-category="toppings">Toppings</button>
            <button class="category-btn" data-category="specialties">Especialidades</button>
            <button class="category-btn" data-category="promotions">Promociones</button>
            <button class="category-btn" data-category="desserts">Postres & Snacks</button> <!-- NUEVO -->
        </nav>

        <!-- Secci√≥n de productos -->
        <section class="products-section">
            <header class="section-header">
                <h2 id="currentCategoryTitle">Frapp√©s Base Agua</h2>
                <button id="addProductBtn" class="admin-btn add">‚ûï A√±adir Nuevo Producto</button>
            </header>
            <div id="productsGrid" class="products-grid">
                <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
                <p class="loading-message">Cargando productos...</p>
            </div>
        </section>
    </div>

    <!-- Modal de edici√≥n/adici√≥n de producto -->
    <div id="productModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="modal-content">
            <button class="close-modal-button" aria-label="Cerrar modal">‚úñ</button>
            <h3 id="modalTitle">A√±adir Nuevo Producto</h3>
            <form id="productForm">
                <div class="form-group">
                    <label for="productName">Nombre:</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label for="productCategory">Categor√≠a:</label>
                    <select id="productCategory" required>
                        <!-- Las opciones se cargar√°n din√°micamente por JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="productDisplayName">Nombre para Mostrar (opcional):</label>
                    <input type="text" id="productDisplayName">
                </div>
                <div class="form-group">
                    <label for="productDescription">Descripci√≥n:</label>
                    <textarea id="productDescription" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label for="productPrice">Precio:</label>
                    <input type="number" id="productPrice" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="productImage">URL de la Imagen:</label>
                    <input type="url" id="productImage" placeholder="https://ejemplo.com/imagen.jpg">
                    <div class="image-preview" id="imagePreview"></div>
                </div>

                <div class="form-group form-group-toggle">
                    <label for="productIsActive">Producto Activo:</label>
                    <input type="checkbox" id="productIsActive" class="toggle-switch">
                    <span class="toggle-label">El producto se mostrar√° en el men√∫.</span>
                </div>

                <div class="form-group" id="categorySpecificFields">
                    <!-- Campos espec√≠ficos por categor√≠a se a√±adir√°n aqu√≠ -->
                </div>

                <div class="form-actions">
                    <button type="button" id="cancelBtn" class="admin-btn cancel">Cancelar</button>
                    <button type="submit" class="admin-btn save">üíæ Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de confirmaci√≥n para eliminar -->
    <div id="confirmModal" class="modal-overlay" role="alertdialog" aria-modal="true" aria-labelledby="confirmModalTitle" aria-describedby="confirmMessage">
        <div class="modal-content confirm-modal">
            <h3 id="confirmModalTitle">¬øConfirmar eliminaci√≥n?</h3>
            <p id="confirmMessage">¬øEst√°s seguro de que quieres eliminar este producto?</p>
            <div class="form-actions">
                <button id="confirmCancel" class="admin-btn cancel">Cancelar</button>
                <button id="confirmDelete" class="admin-btn delete">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Alerta Personalizado (Reemplaza alert()) -->
    <div id="customAlertModal" class="modal-overlay" role="alertdialog" aria-modal="true" aria-labelledby="customAlertTitle" aria-describedby="customAlertMessage">
        <div class="modal-content custom-alert-modal">
            <h3 id="customAlertTitle"></h3>
            <p id="customAlertMessage"></p>
            <button id="customAlertCloseBtn" class="admin-btn">Aceptar</button>
        </div>
    </div>

    <!-- Toast para notificaciones -->
    <div id="toast" class="toast"></div>

    <!-- Plantilla para la tarjeta de producto -->
    <template id="productCardTemplate">
        <div class="product-card">
            <img data-src="" alt="" class="product-image lazy-load" onerror="this.onerror=null;this.src='https://placehold.co/100x100/ADD8E6/000000?text=No+Image';">
            <h4 class="product-name"></h4>
            <p class="product-description"></p>
            <p class="product-price"></p>
            <div class="product-status">
                <label class="switch">
                    <input type="checkbox" class="status-toggle">
                    <span class="slider round"></span>
                </label>
            </div>
            <div class="product-actions">
                <button class="admin-btn edit-btn">‚úèÔ∏è Editar</button>
                <button class="admin-btn delete-btn">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </template>

    <!-- Carga de admin-script.js como un M√ìDULO -->
    <script src="admin-script.js" type="module"></script>

    <!-- Carga de Firebase SDK y l√≥gica de inicializaci√≥n -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { firebaseConfig } from './firebase-config.js'; // Importar configuraci√≥n centralizada

        // Funci√≥n para mostrar el modal de alerta personalizado
        window.showCustomAlert = function(title, message) {
            document.getElementById('customAlertTitle').textContent = title;
            document.getElementById('customAlertMessage').textContent = message;
            if (window.openModal) window.openModal(document.getElementById('customAlertModal'));
        };

        // Event listener para cerrar el modal de alerta
        document.getElementById('customAlertCloseBtn').addEventListener('click', () => {
            if (window.closeModal) window.closeModal(document.getElementById('customAlertModal'));
        });

        // Inicializar Firebase y autenticar
        async function initializeFirebase() {
            // Validar que firebaseConfig no est√© vac√≠o
            if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
                console.error("Firebase config is incomplete. Please update firebaseConfig with your actual Firebase project details.");
                window.showCustomAlert('Error de Configuraci√≥n', 'La configuraci√≥n de Firebase est√° incompleta. Por favor, edita index.html y admin.html con los detalles de tu proyecto Firebase.');
                return; // Detener la inicializaci√≥n
            }

            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                const appId = firebaseConfig.projectId; // Usamos projectId como appId para Firestore
                
                // --- Referencias a elementos del DOM (actualizadas) ---
                const authMessage = document.getElementById('auth-message');
                const adminHeader = document.querySelector('.admin-header');
                const adminContainer = document.querySelector('.admin-container');
                const logoutBtn = document.getElementById('logoutBtn');
                const loginForm = document.getElementById('loginForm');
                const loginError = document.getElementById('loginError');

                // --- L√≥gica de Autenticaci√≥n ---

                // 0. Manejar el env√≠o del formulario de login
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    loginError.style.display = 'none'; // Ocultar errores previos

                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        // onAuthStateChanged se encargar√° de mostrar el panel de admin
                    } catch (error) {
                        console.error("Error al iniciar sesi√≥n:", error.code);
                        let errorMessage = "Correo o contrase√±a incorrectos. Int√©ntalo de nuevo.";
                        if (error.code === 'auth/invalid-email') {
                            errorMessage = "El formato del correo no es v√°lido.";
                        } else if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
                            errorMessage = "Las credenciales son incorrectas. Verifica tu correo y contrase√±a.";
                        } else {
                            errorMessage = "Ocurri√≥ un error inesperado. Revisa la consola para m√°s detalles.";
                        }
                        loginError.textContent = errorMessage;
                        loginError.style.display = 'block';
                    }
                });

                // 1. Escuchar cambios en el estado de autenticaci√≥n
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Usuario est√° autenticado
                        const userId = user.uid;

                        console.log("Usuario autenticado:", userId);

                        // Ocultar login y mostrar panel de admin
                        authMessage.style.display = 'none';
                        adminHeader.style.display = 'flex';
                        adminContainer.style.display = 'block'; // Asegurarse que sea block

                        // Iniciar la l√≥gica del panel de administraci√≥n
                        if (typeof window.initAdminPanel === 'function') {
                            window.initAdminPanel(db, userId, appId);
                        } else {
                            console.error("Error: window.initAdminPanel no es una funci√≥n. Aseg√∫rate de que admin-script.js se cargue correctamente como un m√≥dulo.");
                            window.showCustomAlert('Error Interno', 'No se pudo iniciar el panel de administraci√≥n. Por favor, contacta a soporte.');
                        }
                    } else {
                        // Usuario no est√° autenticado
                        console.log("Usuario no autenticado.");
                        
                        // Mostrar mensaje de autenticaci√≥n y ocultar panel de admin
                        authMessage.style.display = 'flex';
                        adminHeader.style.display = 'none';
                        adminContainer.style.display = 'none';
                    }
                });

                // 3. Manejar el cierre de sesi√≥n
                logoutBtn.addEventListener('click', async () => {
                    try {
                        await signOut(auth);
                        // onAuthStateChanged se encargar√° de mostrar la pantalla de login
                    } catch (error) {
                        console.error("Error al cerrar sesi√≥n:", error);
                        window.showCustomAlert('Error', 'No se pudo cerrar la sesi√≥n.');
                    }
                });

            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                window.showCustomAlert('Error de Inicializaci√≥n', 'No se pudo conectar con el servidor de administraci√≥n. Por favor, int√©ntalo de nuevo m√°s tarde. Verifica tu configuraci√≥n de Firebase.');
            }
        };

        // Asegurarse de que el DOM est√© completamente cargado antes de inicializar Firebase
        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
